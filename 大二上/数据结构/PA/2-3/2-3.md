## PA2a-3 Graph

### 一、算法分析

首先考虑不加边、无零权的情况。

可以通过堆优化 Dijkstra 算法，求出从 $1$ 点出发到其它点的最短路长度，进而根据对于每条边 $e : x \to y$，可通过判断 $dis_x + val_e$ 与 $dis_y$ 是否相等得出此边是否位于最短路网络上。

容易发现这样取出的边构成的新图，必然是一个有向无环图，这意味着，我们可以根据其拓扑序进行更新。

具体来说，假设 $dp_i$ 表示从 $1$ 到 $i$ 的最短路数量，我们只须按照拓扑序取出点 $i$，对于其连出所有边（位于最短路网络上）$e : i \to j$，进行 $dp_i \to dp_j$ 的更新。

最终 $dp_n$ 就会是我们想要得到的，从 $1$ 到 $n$ 的不同最短简单路径数量。

然后考虑存在询问加边的情况，不妨先对 $1$ 和 $n$ 各进行一次单源最短路计算，设得出的最短距离分别是 $dis_{1, i}$ 和 $dis_{n, i}$，并且各自进行方案数计算，设方案数分别为 $dp_{1, i}$ 和 $dp_{n, i}$。

那么，对于加入的边 $e : x \to y$，其边权为 $w$（分别考虑两个方向）：

- 如果 $dis_{1, x} + w + dis_{n, y} > dis_{1, n}$，则此边对最短路长度与最短路网络无影响，可知答案仍然会是 $dp_{1, n}$。
- 如果 $dis_{1, x} + w + dis_{n, y} = dis_{1, n}$，则此边对最短路长度无影响，而最短路网络中会加入此边，并导致增加 $dp_{1, x} \times dp_{n, y}$ 的方案数，因此总方案数为 $dp_{1, n} + dp_{1, x} \times dp_{n, y}$。
- 如果 $dis_{1, x} + w + dis_{n, y} > dis_{1, n}$，则此边对最短路长度有影响，并且原先最短路网络因此只会保留 $1$ 到 $x$ 和 $y$ 到 $n$ 的两部分，最终方案数为 $dp_{1, x} \times dp_{n, y}$。

接下来考虑存在零边的情况。

由于题中保证了无零环，因此零边构成的子图必定是一个”森林“，即每个连通块会构成一个树结构。

那么任意一对树上的点，其之间的路径数量应该恰好为 $1$，因此如果将所有零边连成的连通块缩为一个点，则到其中任意一个点的最短路数量，就恰好等于新图意义下这个新点的最短路数量（考虑重边）。

则在进行缩点之后，最终的最短路网络将仍然是一个有向无环图。

缩点可以考虑采用带路经压缩的并查集完成。

### 二、复杂度分析

利用带路经压缩的并查集进行零边缩点的复杂度不超过 $O(n + m)$。

堆优化 Dijkstra 的时间复杂度为 $O((n + m) \log m)$，取出最短路网络并进行拓扑排序和动态规划计算方案数的时间复杂度为 $O(n + m)$。

每次询问时的判断时间复杂度是常数，即 $O(1)$，因此总体时间复杂度为 $O((n + m) \log m + q)$。

而空间上，通过邻接表存储边，空间复杂度为 $O(m)$。

其他数组均为关于单点的信息，因此对应复杂度为 $O(n)$，故总体空间复杂度为 $O(n + m)$。

### 三、问题与解决

由于输入的边权范围在 $2^{31}$ 级别，因此求最短路时应通过 `unsigned long long` 类型存储，以防越界。

建立最短路网络时，应该对于 $1$ 和 $n$ 各自建立，若根据 $dis_{1, x} + w + dis_{n, y} = dis_{1, n}$ 的条件，则可能导致新加入边时，本应考虑方案数呗忽略。

